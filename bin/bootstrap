#!/bin/bash

# Exit if any command fails
set -e

# In non-interactive shells aliases are not expanded without this
shopt -s expand_aliases

declare -ra TAPS=(
  'caskroom/fonts'
  'caskroom/versions'
  'neovim/neovim'
)

declare -ra FORMULAE=(
  'bash'
  'git'
  'fzf'
  'mutt'
  'neovim'
  'the_silver_searcher'
  'vifm'
  'youtube-dl'
)

declare -ra CASKS=(
  'firefox'
  'font-source-code-pro'
  'gimp'
  'google-chrome'
  'iterm2-beta'
  'keka'
  'skype'
  'spectacle'
  'telegram'
  'transmission'
  'vlc'
  'virtualbox'
)

declare -ra NPM_PACKAGES=(
  'how2'
  'speed-test'
  'vtop'
)

declare -xr RED='\033[0;31m'
declare -xr GREEN='\033[0;32m'
declare -xr YELLOW='\033[0;33m'
declare -xr MAGENTA='\033[0;95m'
declare -xr BLUE='\033[0;94m'
declare -xr RESET='\033[0m'

printError() {
  printf "${RED}$1${RESET}\n" 1>&2;
}

printWarning() {
  printf "${YELLOW}$1${RESET}\n" 1>&2;
}

printSuccess() {
  printf "${GREEN}$1${RESET}\n" 1>&2;
}

printInfo() {
  printf "${BLUE}$1${RESET}\n" 1>&2;
}

commandExists() {
  which "$1" &>/dev/null
}

isFormulaInstalled() {
  brew list "$1" &>/dev/null
}

isFormulaOutdated() {
  ! brew outdated "$1" &>/dev/null
}

isCaskInstalled() {
  brew cask list "$1" &>/dev/null
}

installOrUpgradeFormula() {
  if isFormulaInstalled "$1"; then
    if isFormulaOutdated "$1"; then
      printInfo "Upgrading $1"
      brew upgrade "$@"
    fi
  else
    printInfo "Installing $1"
    brew install "$@"
  fi
}

installCask() {
  if ! isCaskInstalled "$1"; then
    printInfo "Installing $1"
    brew cask install "$@"
  fi
}

if ! commandExists brew; then
  printInfo 'Installing Homebrew'
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

for i in "${TAPS[@]}"
do
  brew tap "$i" 2> /dev/null
done

printInfo 'Updating Homebrew'
brew update

for i in "${FORMULAE[@]}"
do
  installOrUpgradeFormula "$i"
done

for i in "${CASKS[@]}"
do
  installCask "$i"
done

if [ -z "$NVM_DIR" ]; then
  NVM_DIR="$HOME/.nvm"
fi
NVM_SH="$NVM_DIR/nvm.sh"

if [ -d "$NVM_DIR" ]; then
  printInfo 'Updating nvm'
  git -C "$NVM_DIR" pull origin master
else
  printInfo 'Installing nvm'
  git clone https://github.com/creationix/nvm.git "$NVM_DIR"
fi
git -C "$NVM_DIR" checkout "$(git describe -C "$NVM_DIR" --abbrev=0 --tags)"

printInfo 'Loading nvm'
source "$NVM_SH"

printInfo 'Installing latest version of Node'
nvm install stable

printInfo 'Installing/updating npm packages'
npm install -g "${NPM_PACKAGES[@]}"

alias dotfiles='git --git-dir=$HOME/.dotfiles --work-tree=$HOME'
if [ -d "$HOME/.dotfiles" ]; then
  printInfo "Updating dotfiles from $(dotfiles config --get remote.origin.url)"
  dotfiles pull
else
  if [ -z "$1" ]; then
    printWarning 'No dotfiles repository was provided.'
  else
    printInfo "Cloning dotfiles from $1"
    git clone --bare "$1" "$HOME/.dotfiles"
    dotfiles config --local status.showUntrackedFiles no
    dotfiles checkout
  fi
fi

itermSettingsFile="$HOME/.config/iterm2/com.googlecode.iterm2.plist"
if [ -f "$itermSettingsFile" ]; then
  printInfo "Importing iTerm2 settings."
  defaults write com.googlecode.iterm2 "$(cat "$itermSettingsFile")"
fi
